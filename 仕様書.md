## 📋 仕様書：学習集中Chrome拡張

### コンセプト

勉強する項目を登録し、閲覧中のコンテンツが**意味的に関連しているか**を**AI（Transformers.js）**で判定。関連しなければ**邪魔する広告**のような警告画面で妨害し、YouTube ShortsやInstagramなどの明らかな脱線コンテンツは**完全ブロック**する。

---

### 機能一覧

| 機能 | 説明 |
| --- | --- |
| **勉強項目の登録** | ユーザーが「英語の勉強」「レポート作成」などを登録。**自動類語展開**（例: program → coding, algorithm）により、関連語もカバー。**ON/OFFトグル**で個別に有効/無効切替可能。 |
| **拡張機能ON/OFF** | ポップアップから判定・ブロック機能全体を一時的に無効化できる。 |
| **文脈解析** | ページタイトル、H1、meta description、さらに**YouTubeの隠しメタデータ（ジャンル、詳細説明）**を取得して解析。 |
| **ベクトル類似度判定** | **Transformers.js (MiniLM-L12)** を使用し、登録項目と閲覧内容の意味的な関連性をスコアリング。 |
| **学習モード判定** | 「教育（Education）」「科学（Science）」などのカテゴリ、またはキーワード一致で**スコアボーナス**を付与。逆にSNS等はペナルティ。 |
| **邪魔する広告** | 関連性が低い（スコア < 0.35）場合、"🥺"などのキャラクターと共に警告オーバーレイを表示し、再確認を促す。**閉じた後2分後に再判定**。 |
| **定期判定** | **30秒ごと**に自動で関連性を再チェック。 |
| **完全ブロック** | YouTube Shorts（`youtube.com/shorts/`）および **Instagram**（`instagram.com`）を検知し、即座に黒画面で完全ブロック（デフォルト）。 |
| **Twitter/X補正** | ホームタイムライン（`/home`, `/`）には追加ペナルティ（-0.15）を適用。 |
| **許可サイト設定** | 指定したサイトはスコア測定・警告を完全スキップ（禁止設定より強力）。 |
| **禁止サイト設定** | 指定したサイト・URLパターンを完全ブロック（カスタマイズ可能）。 |
| **統計機能** | 我慢回数、閲覧時間を記録・可視化（日別/月別グラフ）。 |
| **詳細設定ページ** | ポップアップから開く別ページで、サイト設定・記録設定・統計閲覧・データ管理が可能。 |

---

### 技術スタック

| 項目 | 技術 |
| --- | --- |
| プラットフォーム | Chrome拡張機能（Manifest V3） |
| 言語 | HTML / CSS / JavaScript |
| ベクトル埋め込み | **Transformers.js** + **Xenova/paraphrase-multilingual-MiniLM-L12-v2** |
| サンドボックス | `sandbox` ページ内でWasm版ONNX Runtimeを実行（CSP制限回避のため） |
| データ保存 | Chrome Storage API |
| グラフ表示 | **Chart.js** |

---

### 処理フロー

```
1. ユーザーが勉強項目を登録（例: "Math"）
   - 各項目はON/OFFトグルで有効/無効を切替可能
2. ページ遷移 or URL変更を検知
   - 拡張機能OFFの場合 → スキップ
   - URLが許可リストに含まれる → 判定スキップ
   - URLが禁止リスト/パターンに含まれる → 即ブロック
3. ページの情報を収集
   - タイトル + H1 + Meta Description
   - YouTube json-ld (Genre, Description)
4. Offscreen/Sandboxでベクトル化＆類似度計算 (Transformers.js)
   - ベーススコア算出（コサイン類似度）
   - ボーナス: キーワード一致 (+0.5), 教育カテゴリ (+0.3)
   - ペナルティ: SNSドメイン (-0.2), Twitter/Xホーム (-0.15)
5. 最終スコア < 0.35 (閾値) → 邪魔するオーバーレイを表示
   - 「勉強に関係ありますか？」と問いかけ
   - 閉じた後、2分後に再判定
   - 警告を閉じずにページを離れた場合 → 「我慢回数」として記録
6. 30秒ごとに自動で再判定（定期チェック）
7. 閲覧時間を30秒ごとにバッチ保存（記録機能有効時）
```

---

### 判定タイミング

| シチュエーション | タイミング |
|----------------|-----------| 
| 初回判定 | ページ読み込み後 2秒 |
| URL変更時 | 即座に判定 |
| 定期判定 | **30秒ごと** |
| 警告を閉じた後の再判定 | **2分後** |

---

### ポップアップUI

- **スコア表示**: 現在のタブの判定スコアをリアルタイム表示（色分け: 緑=OK、黄=注意、赤=ブロック）
- **拡張機能ON/OFF**: 判定・ブロック機能の一時無効化トグル
- **勉強内容リスト**: 各項目にON/OFFトグルと削除ボタン
- **詳細設定ボタン**: 設定・統計ページを開くボタン

---

### 詳細設定ページ

| タブ | 機能 |
| --- | --- |
| **統計** | 日別/月別の閲覧時間グラフ（iPhoneスクリーンタイム風）、我慢回数表示、ドメイン別使用時間リスト |
| **サイト設定** | 許可サイト・禁止サイト・禁止パターンの追加/削除 |
| **記録設定** | 我慢回数・閲覧時間・SNS時間のみの記録ON/OFF |
| **データ管理** | エクスポート（JSON/CSV）、インポート（JSON）、期間指定データ削除、全データ削除 |

---

### 統計機能

#### 記録オプション（初回起動時に確認ダイアログ）
- デフォルト: **記録OFF**
- 選択可能な項目:
  - **我慢回数を記録**: 警告表示中にページを離れた回数
  - **閲覧サイト・時間を記録**: どのサイトをどれくらい見たか
  - **SNSの時間だけ記録**: 閲覧時間記録OFFの場合のみ有効

#### グラフ表示
- **日別**: 1ヶ月分の棒グラフ
- **月別**: 1年分の棒グラフ
- 棒をクリックすると詳細（ドメイン別使用時間リスト）を表示
- **判定ON/OFF別フィルター**: ONの時/OFFの時/合計を切り替え可能

#### データ保存
- すべてローカル保存（プライバシー重視）
- 期間指定で削除可能

#### エクスポート/インポート
- **JSONエクスポート**: バックアップ/リストア用。設定・勉強項目・統計データを含む
- **CSVエクスポート**: Excelでピボットテーブル/グラフ作成に最適な形式
  - 閲覧時間CSV: `日付, ドメイン, 閲覧時間(分), 判定機能`
  - 我慢回数CSV: `日付, ドメイン, 我慢回数`
- **JSONインポート**: マージまたは置き換えモードを選択可能

---

### 許可・禁止サイト設定

#### 許可サイト（Allowlist）
- 指定したドメインはスコア測定・警告を**完全スキップ**
- 禁止サイト設定より**優先される**
- 例: `youtube.com/shorts` を禁止しても、`youtube.com` を許可すればShortsも見れる

#### 禁止サイト（Blocklist）
- 指定したドメインを**完全ブロック**
- デフォルト: `instagram.com`

#### 禁止パターン
- 特定のURLパス（`domain` + `pathPattern`）をブロック
- デフォルト: `youtube.com/shorts`

---

### 邪魔する広告（警告）の仕様

- **オーバーレイ**: 画面下部に固定などではなく、コンテンツを覆う形で警告を表示。
- **メッセージ**: 「類似度スコア: 0.15 (判定: 低)」「登録された勉強内容と関連が薄い可能性があります。」
- **解除**: 「関係ある（閉じる）」ボタンでのみ解除可能（能動的な意思表示が必要）。
- **再判定**: 閉じた後**2分後に自動で再判定**し、スコアが低ければ再度オーバーレイを表示。
- **我慢イベント**: 警告表示中にページを離れると「我慢回数」として記録（記録ON時）。

---

### 補足：AIモデルについて

**Transformers.js + Xenova/paraphrase-multilingual-MiniLM-L12-v2** を使用：

- **多言語対応**: 日本語、英語など50以上の言語を同一ベクトル空間にマッピング可能。
- **高精度**: 単なる単語一致ではなく、文脈的な意味の近さを判定。
- **完全ローカル**: 外部API（OpenAI等）は一切使用せず、ブラウザ内ですべて完結。プライバシーも安全。